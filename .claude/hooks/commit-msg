#!/usr/bin/env bash
#
# Commit-msg hook: Validate commit message format
# Ensures conventional commit format: type: description
#
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge"; then
    exit 0
fi

# Valid commit types
VALID_TYPES="feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert"

# Check format: type: description or type(scope): description
if echo "$COMMIT_MSG" | grep -qE "^($VALID_TYPES)(\(.+\))?: .{3,}"; then
    echo -e "${GREEN}✓${NC} Commit message format valid"
    exit 0
else
    echo ""
    echo "════════════════════════════════════════════════════════"
    echo -e "  ${RED}❌ Invalid Commit Message Format${NC}"
    echo "════════════════════════════════════════════════════════"
    echo ""
    echo -e "${RED}Your commit message:${NC}"
    echo "  $COMMIT_MSG"
    echo ""
    echo -e "${YELLOW}Required format:${NC}"
    echo "  type: description"
    echo "  type(scope): description"
    echo ""
    echo -e "${YELLOW}Valid types:${NC}"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  docs     - Documentation changes"
    echo "  style    - Code style/formatting"
    echo "  refactor - Code refactoring"
    echo "  test     - Adding/updating tests"
    echo "  chore    - Maintenance tasks"
    echo "  perf     - Performance improvements"
    echo "  ci       - CI/CD changes"
    echo "  build    - Build system changes"
    echo "  revert   - Revert previous commit"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  feat: add user authentication"
    echo "  fix(api): handle null pointer in user service"
    echo "  docs: update README with installation steps"
    echo ""
    echo -e "${YELLOW}See also:${NC}"
    echo "  cat .claude/skills/git-workflow/skill.md"
    echo ""
    echo -e "${YELLOW}To bypass (NOT recommended):${NC}"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
