#!/usr/bin/env bash
#
# Pre-push hook: Final checks before pushing to remote
# Ensures tests pass, no TODOs in committed code, TASKS.md updated
#
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo "════════════════════════════════════════════════════════"
echo -e "  ${GREEN}Running Pre-Push Checks${NC}"
echo "════════════════════════════════════════════════════════"
echo ""

FAILED=0

# Check 1: Ensure all tests pass
echo -e "${YELLOW}Checking tests...${NC}"
if [ -d "tests" ]; then
    # Detect test framework
    if [ -f "pytest.ini" ] || [ -f "pyproject.toml" ]; then
        if command -v pytest &> /dev/null; then
            if pytest -q 2>&1; then
                echo -e "${GREEN}✓${NC} All tests pass"
            else
                echo -e "${RED}✗${NC} Tests failed"
                FAILED=1
            fi
        else
            echo -e "${YELLOW}⚠${NC} pytest not found, skipping"
        fi
    elif [ -f "package.json" ]; then
        if npm test 2>&1; then
            echo -e "${GREEN}✓${NC} All tests pass"
        else
            echo -e "${RED}✗${NC} Tests failed"
            FAILED=1
        fi
    elif [ -f "go.mod" ]; then
        if go test ./... 2>&1; then
            echo -e "${GREEN}✓${NC} All tests pass"
        else
            echo -e "${RED}✗${NC} Tests failed"
            FAILED=1
        fi
    fi
else
    echo -e "${YELLOW}⚠${NC} No tests directory found"
fi
echo ""

# Check 2: No TODO/FIXME in committed code
echo -e "${YELLOW}Checking for TODO/FIXME markers...${NC}"
TODO_COUNT=$(git diff origin/$(git branch --show-current) --cached --diff-filter=ACM | grep -E "^\+.*TODO|^\+.*FIXME" | wc -l || true)
if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "${RED}✗${NC} Found $TODO_COUNT TODO/FIXME markers in committed code"
    echo ""
    git diff origin/$(git branch --show-current) --cached --diff-filter=ACM | grep -E "^\+.*TODO|^\+.*FIXME" || true
    echo ""
    echo -e "${YELLOW}Remove TODO/FIXME or create issues for them${NC}"
    FAILED=1
else
    echo -e "${GREEN}✓${NC} No TODO/FIXME markers"
fi
echo ""

# Check 3: TASKS.md exists and is not empty
echo -e "${YELLOW}Checking TASKS.md...${NC}"
if [ -f ".claude/TASKS.md" ]; then
    if [ -s ".claude/TASKS.md" ]; then
        echo -e "${GREEN}✓${NC} TASKS.md exists and has content"
    else
        echo -e "${YELLOW}⚠${NC} TASKS.md is empty"
    fi
else
    echo -e "${YELLOW}⚠${NC} TASKS.md not found"
fi
echo ""

# Final verdict
if [ $FAILED -eq 1 ]; then
    echo "════════════════════════════════════════════════════════"
    echo -e "  ${RED}❌ Pre-Push Checks FAILED${NC}"
    echo "════════════════════════════════════════════════════════"
    echo ""
    echo -e "${RED}Push blocked due to issues above.${NC}"
    echo ""
    echo -e "${YELLOW}Fix the issues and try again, or:${NC}"
    echo ""
    echo "  • Bypass (NOT recommended):"
    echo "    git push --no-verify"
    echo ""
    exit 1
else
    echo "════════════════════════════════════════════════════════"
    echo -e "  ${GREEN}✅ Pre-Push Checks PASSED${NC}"
    echo "════════════════════════════════════════════════════════"
    echo ""
    exit 0
fi
